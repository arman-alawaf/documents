<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laravel Documents</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>

    <section>
      <div class="container-fluid py-3">
        <div class="row">
          <div class="col-12">

            <textarea rows="22" cols="100" class="form-control">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\Doctor;  
use Illuminate\Support\Facades\File;
use Intervention\Image\Facades\Image;

class DoctorController extends Controller
{
    public function index(){
        return view('backend.admin.doctors.index');
    }
    
    public function store(Request $request){

        $data = new Doctor;  

        $data->speciality_id = $request->speciality_id; 
        $data->name = $request->name; 
        $data->visit_price = $request->visit_price;
        $data->address = $request->address;

        $destinationPath = public_path('images/doctors/');
        if (!file_exists($destinationPath)) {
            mkdir($destinationPath, 0777, true);
        }

        // ---- IMAGE ----
        if ($request->hasFile('image')) {
            $image = $request->file('image');
            $extension = strtolower($image->getClientOriginalExtension());

            if ($extension === 'svg') {
                $imageName = 'image' . time() . '.svg';
                $image->move($destinationPath, $imageName);
            } else {
                $imageName = 'image' . time() . '.webp';
                Image::make($image->getRealPath())->encode('webp', 90)->save($destinationPath . $imageName);
            }

            $data->image = $imageName;
        }

        $data->save();

        return redirect()->back()->with('success', 'Added Successfully Done.');
    }

    public function update(Request $request, $id){
        
        $data = Doctor::findOrFail($id);

        $data->speciality_id = $request->speciality_id;
        $data->name = $request->name;
        $data->visit_price = $request->visit_price;
        $data->address = $request->address;

        $destinationPath = public_path('images/doctors/');
        if (!file_exists($destinationPath)) {
            mkdir($destinationPath, 0777, true);
        }

        // ---- IMAGE ----
        if ($request->hasFile('image')) {
            $image = $request->file('image');
            $extension = strtolower($image->getClientOriginalExtension());

            if (!empty($data->image) && file_exists($destinationPath . $data->image)) {
                unlink($destinationPath . $data->image);
            }
            if ($extension === 'svg') {
                $imageName = 'image' . time() . '.svg';
                $image->move($destinationPath, $imageName);
            } else {
                $imageName = 'image' . time() . '.webp';
                Image::make($image->getRealPath())->encode('webp', 90)->save($destinationPath . $imageName);
            }

            $data->image = $imageName;
        }

        $data->save();

        return redirect()->back()->with('success', 'Updated Successfully Done.');
    }

    public function destroy(Request $request, $id){
        $data = Doctor::findOrFail($id);
        $destination = 'images/doctors/'.$data->image; if(File::exists($destination)){ File::delete($destination); }
        $data->delete();
        return redirect()->back()->with('error','Deleted Successfully Done.');
    }

}

            </textarea>

          </div>
        </div>
      </div>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  </body>
</html>